<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalkulator dyżurów medycznych v0.0.2</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; }
        .table-responsive { max-height: auto; overflow-y: auto; }
    </style>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-NT0BFMBWPK"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-NT0BFMBWPK');
    </script>

</head>
<body>
    <div class="container">
        <h1 class="mb-4">Kalkulator dyżurów medycznych v0.0.2</h1>
        <p class="lead">Wypełnij formularz z dyżurami i naciśnij "Oblicz" żeby zobaczyć swój dochód.</p>
        
        <form class="mb-4">
            <div class="row g-3 align-items-center">
                <div class="col-auto">
                    <label for="basicRate" class="col-form-label">Twoja stawka podstawowa:</label>
                </div>
                <div class="col-auto">
                    <input type="number" id="basicRate" class="form-control" value="20" min="0" step="0.01">
                </div>
                <div class="col-auto">
                    <span class="form-text">PLN</span>
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-primary" onclick="calculateIncome()">Oblicz</button>
                </div>
            </div>
        </form>

        <div class="col-auto">
            <p id="result"></p>
        </div>

        <div class="row mb-3">
            <div class="col-md-4">
                <label for="monthSelector" class="form-label">Wybierz miesiąc:</label>
                <select id="monthSelector" class="form-select">
                        <option value="1">Styczeń</option>
                        <option value="2">Luty</option>
                        <option value="3">Marzec</option>
                        <option value="4">Kwiecień</option>
                        <option value="5">Maj</option>
                        <option value="6">Czerwiec</option>
                        <option value="7">Lipiec</option>
                        <option value="8">Sierpień</option>
                        <option value="9">Wrzesień</option>
                        <option value="10">Październik</option>
                        <option value="11">Listopad</option>
                        <option value="12">Grudzień</option>
                    <!-- Add other months here -->
                </select>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead id="calendarHeader">
                    <tr>
                        <th>Data</th>
                        <th>Dzień</th>
                        <th>Start dyżuru</th>
                        <th>Czas trwania dyżuru</th>
                    </tr>
                </thead>
                <tbody id="calendarBody">
                    <!-- Table rows will be dynamically generated here -->
                </tbody>
            </table>
        </div>
    </div>

<script src='https://storage.ko-fi.com/cdn/scripts/overlay-widget.js'></script>
<script>
    kofiWidgetOverlay.draw('peterwallace', {
    'type': 'floating-chat',
    'floating-chat.donateButton.text': 'Support me',
    'floating-chat.donateButton.background-color': '#00b9fe',
    'floating-chat.donateButton.text-color': '#fff'
    });
</script>

<script>
// Get today's date
const today = new Date();
const year = today.getFullYear();
// const month = today.getMonth();
const monthSelector = document.getElementById('monthSelector');

// Function to get the number of days in a month
function daysInMonth(year, month) {
    return new Date(year, month + 1, 0).getDate();
}

// Generate calendar with days and hours
function generateCalendar(month) {
    const calendarHeader = document.getElementById('calendarHeader');
    calendarHeader.innerHTML = '';
    const calendarBody = document.getElementById('calendarBody');
    calendarBody.innerHTML = ''; // Clear previous calendar
    
    // Generate header row with days
    const headerRow = document.createElement('tr');
    const emptyCell = document.createElement('th');
    const headers = ["data","dzień","start dyżuru","czas trwania dyżuru"];
    for (let n = 0; n <= headers.length - 1; n++) {
        const columnHeader = document.createElement('th');
        columnHeader.innerText = headers[n];
        headerRow.appendChild(columnHeader);
    }
    calendarHeader.appendChild(headerRow);

    // Generate body rows with hours (0-23)
    const daysOfWeek = ["Nd", "Pn", "Wt", "Śr", "Czw", "Pt", "So"];
    const days = daysInMonth(year, month - 1);
    for (let day = 1; day <= days; day++) {
        const row = document.createElement('tr');

        // Hour label
        const dateCell = document.createElement('td');
        dateCell.innerText = `${year}-${month}-${day}`;
        row.appendChild(dateCell);
        
        const date = new Date(dateCell.innerText);
        const dayIndex = date.getDay(); // Get the day of the week (0-6)
        
        const dayNameCell = document.createElement('td');
        dayNameCell.innerText = daysOfWeek[dayIndex];
        row.appendChild(dayNameCell);

        // Hour chooser (third column)
        const hourChooserCell = document.createElement('td');
        const hourChooser = document.createElement('select');

        // Create options for hours from 0 to 12
        for (let hour = 0; hour <= 23; hour++) {
            const option = document.createElement('option');
            option.value = hour;
            option.innerText = hour.toString().padStart(2, '0') + ':00';
            hourChooser.appendChild(option);
        }

        hourChooserCell.appendChild(hourChooser);
        row.appendChild(hourChooserCell);

        // Time duration chooser (fourth column)
        const durationChooserCell = document.createElement('td');
        const durationChooser = document.createElement('select');

        // Create options for durations from 0 to 12 hours
        for (let duration = 0; duration <= 16; duration++) {
            const option = document.createElement('option');
            option.value = duration;
            option.innerText = duration + ' godzin' + (duration === 1 ? 'e' : '') + ([2,3,4].includes(duration)? 'y' : '');
            durationChooser.appendChild(option);
        }

        durationChooserCell.appendChild(durationChooser);
        row.appendChild(durationChooserCell);

        calendarBody.appendChild(row);
    }
}

// Toggle the selection of a cell when clicked
function toggleHour(cell) {
    cell.classList.toggle('selected');
}

function getSelectedHoursAndDurations() {
    const calendarBody = document.getElementById('calendarBody');
    const rows = calendarBody.getElementsByTagName('tr');
    const selectedData = [];

    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];

        // Grab the date (first cell)
        const date = row.cells[0].innerText;

        // Grab the selected hour (third cell)
        const hourSelect = row.cells[2].getElementsByTagName('select')[0];
        const selectedHour = hourSelect.value;

        // Grab the selected duration (fourth cell)
        const durationSelect = row.cells[3].getElementsByTagName('select')[0];
        const selectedDuration = durationSelect.value;

        // Push the result as an object (or array) to the list
        selectedData.push({
            date: date,
            hour: selectedHour,
            duration: selectedDuration
        });
    }

    return selectedData;
}

function isSunday(dateString)
{
    const date = new Date(dateString);
    const dayIndex = date.getDay(); // Get the day of the week (0-6)
    if(dayIndex == 0){
        return true;
    }
    return false;
};

function isPolishHoliday(dateString)
{
    // Parse the date string to create a Date object
    const date = new Date(dateString);
    const dayOfWeek = date.getDay();
    const day = date.getDate();
    const month = date.getMonth() + 1; // JavaScript months are 0-based, so add 1
    const year = date.getFullYear();

    // Check for fixed-date holidays
    if (dayOfWeek === 0) return true; // Sunday
    if (month === 1 && day === 1) return true; // Nowy Rok
    if (month === 5 && day === 1) return true; // 1 maja
    if (month === 5 && day === 3) return true; // 3 maja
    if (month === 8 && day === 15) return true; // Wniebowzięcie Najświętszej Marii Panny, Święto Wojska Polskiego
    if (month === 11 && day === 1) return true; // Dzień Wszystkich Świętych
    if (month === 11 && day === 11) return true; // Dzień Niepodległości 
    if (month === 12 && day === 25) return true; // Boże Narodzenie
    if (month === 12 && day === 26) return true; // Boże Narodzenie

    // Calculate Easter Sunday date
    const a = year % 19;
    const b = year % 4;
    const c = year % 7;
    let d = (a * 19 + 24) % 30;
    const e = (2 * b + 4 * c + 6 * d + 5) % 7;

    if (d === 29 && e === 6) d -= 7;
    if (d === 28 && e === 6 && a > 10) d -= 7;

    const easter = new Date(year, 2, 22 + d + e); // Easter is on March 22 + d + e days
    const easterMonday = new Date(easter);
    easterMonday.setDate(easter.getDate() + 1); // Easter Monday

    const corpusChristi = new Date(easter);
    corpusChristi.setDate(easter.getDate() + 60); // Corpus Christi

    if (date.toDateString() === easterMonday.toDateString()) return true; // Wielkanoc (poniedziałek)
    if (date.toDateString() === corpusChristi.toDateString()) return true; // Boże Ciało

    return false;
}

function isNightShift(hour)
{
    if(hour > 21){
        return true;
    }
    else if(hour < 7)
    {
        return true;
    }
    return false;
};

function incrementDate(dateString) {
    // Convert the date string to a Date object

    // Create a Date object
    const date = new Date(dateString);

    // Increment the date by 1 day
    date.setDate(date.getDate() + 1);

    // Format the date back to YYYY-MM-DD
    const newYear = date.getFullYear();
    const newMonth = (date.getMonth() + 1).toString().padStart(2, '0'); // Months are 0-based
    const newDay = date.getDate().toString().padStart(2, '0');

    return `${newYear}-${newMonth}-${newDay}`;
}

// Calculate total income based on selected hours
function calculateIncome() {
    const hourlyRate = parseFloat(document.getElementById('basicRate').value);
    const workingPeriodsData = getSelectedHoursAndDurations();
    
    let totalIncome = 0;
    let totalHours = 0;
    for(let i = 0; i < workingPeriodsData.length; i++)
    {
        let shift = workingPeriodsData[i];
        let date = shift.date;
        let starting_hour = parseInt(shift.hour, 10);
        let duration = parseInt(shift.duration,10);

        for(let h = 0; h < duration; h++)
        {
            if(starting_hour + h >= 24)
            {
                starting_hour = 0;
                date = incrementDate(date);
            }

            let bonuses = 0;
            if(isSunday(date) || isPolishHoliday(date))
            {
                bonuses += hourlyRate * 0.45; // w niedzielę święta i dni wolne od pracy przysługuje z kolei dodatek w wysokości nie niższej niż 45% stawki godzinowej.
            }
            if(isNightShift(starting_hour + h))
            {
                bonuses += hourlyRate * 0.65; // Za pracę w godzinach nocnych przysługuje dodatek w wysokości nie mniejszej niż 65% stawki godzinowej.
            }
            
            totalIncome += hourlyRate + bonuses;
            totalHours += 1;
            
        }
    }

    document.getElementById('result').innerText = `Dochód: ${totalIncome.toFixed(2)} PLN. Przepracowane godziny: ${totalHours}.`;
}

// Update the calendar when the month is selected
monthSelector.addEventListener('change', (event) => {
    console.log(event.target.value)
    const selectedMonth = parseInt(event.target.value);
    generateCalendar(selectedMonth);
});

// Initialize the calendar with the current month
monthSelector.value = today.getMonth() + 1;  // Set the select to current month
generateCalendar(monthSelector.value);        // Render the current month's calendar


// Generate the calendar when the page loads
// generateCalendar();
</script>

</body>
</html>
